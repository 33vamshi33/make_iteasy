{% extends "base.html" %}
{% block content %}
  <div class="jumbotron">
    <h1>hey  {{ user.username}}</h1>
    <br>
    <br>
    {% if asize %}
      <ul class="list-group">
        <li class="list-group-item active"><h3>Accepted Requests ({{ asize }})</h3></li>
        {% for item in acceptedrequests_with_disputes %}
        <li class="list-group-item">
          <form action="" method="POST"> {# Action can be current page or specific view for POST #}
            {% csrf_token %}
            <h5 style="float: left;">From: {{ item.connection.customer.user.username }}</h5>
            <input type="hidden" name="connection" value="{{ item.connection.pk }}">
            <input type="submit" class="btn btn-success btn-sm" name="completed" value="Mark as Completed" style="float: right; margin-left:5px;">
          </form>
          <br style="clear:both;">
          <p class="mb-1"><small>Requested: {{ item.connection.created_time|date:"F d, Y H:i" }} | Accepted: {{ item.connection.modified_time|date:"F d, Y H:i" }}</small></p>
          <p class="mb-1"><strong>About:</strong> {{ item.connection.description }}</p>
          
          {% if item.latest_dispute %}
            <div class="mt-2 p-2 border border-danger rounded bg-light">
              <p class="text-danger mb-1"><strong>Dispute Reported (Status: {{ item.latest_dispute.status }})</strong></p>
              <p class="small mb-0"><strong>Reason:</strong> {{ item.latest_dispute.reason|truncatewords:30 }}</p>
              <p class="small text-muted mb-0">Reported by: {{ item.latest_dispute.reporter_user.username }} on {{ item.latest_dispute.created_at|date:"F d, Y H:i" }}</p>
            </div>
          {% endif %}

          <p class="mt-2">You can also chat here with {{ item.connection.customer.user.username }}:</p>
          <a href="{% url 'app1:broker_chat' pk=item.connection.customer.pk %}" class="btn btn-primary btn-sm" style="float: right;">Chat</a>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No accepted requests.</p>
    {% endif %}
  </div>
{% endblock content %}