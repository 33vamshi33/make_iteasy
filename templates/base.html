<!doctype html>
{% load static %}
{% load bootstrap4 %}
{% load humanize %}
{% load crispy_forms_tags %}
<html lang="en">
  <head>
    <title>workiteasy</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <!-- CSS only -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <!-- <style>
      .jumbotron{
        background-image:url({% static 'img/team7.jpg'%}) ;
      }
    </style> -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script data-ad-client="ca-pub-1410057900464970" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>
  <body>
    <!-- <nav class="nav nav-tabs nav-stacked">
      <a class="nav-link active" href="#">Active link</a>
      <a class="nav-link" href="#">Link</a>
      <a class="nav-link disabled" href="#">Disabled link</a>
    </nav> -->
    {% if user.is_authenticated %}
      {% if user.is_customer %}
        <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
          <a class="navbar-brand" href="{% url 'app1:customer_home' %}">HOME</a>
          <div class="collapsex navbar-collapsex" id="collapsibleNavId">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
              <li class="nav-item ">
                <a class="nav-link" href="{% url 'app1:customer_profile' %}">Your profile</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="{% url 'app1:customer_orders' %}" role="button" aria-haspopup="true" aria-expanded="false"> my orders</a>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="{% url 'app1:customer_pendingorders' %}">Pending orders</a>
                  <a class="dropdown-item" href="{% url 'app1:customer_acceptedorders' %}">Accepted orders </a>
                  <a class="dropdown-item" href="{% url 'app1:customer_rejectedorders' %}">Rejected orders</a>
                  <a class="dropdown-item" href="{% url 'app1:customer_completedorders' %}">Completed orders</a>
                  <a class="dropdown-item" href="{% url 'app1:customer_orders' %}">All orders</a>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="{% url 'app1:customer_orders' %}" role="button" aria-haspopup="true" aria-expanded="false">Notifications 
                  {% ifequal tl 0  %} 
                  <span id="notification-count-customer" style="color:cyan;"></span>
                  {% else %}
                  <span id="notification-count-customer" style="color:cyan;">{{tl}}</span>
                  {% endifequal %}
                </a>
                <div class="dropdown-menu">
                  {% include "_notification.html" %}
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'app1:blog_post_list' %}">Blog</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="{% url 'app1:customer_logout' %}">logout</a>
              </li>
            </ul>
          </div>
        </nav>
      {% endif %}
      {% if user.is_broker %}
        <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
          <a class="navbar-brand" href="{% url 'app1:broker_home' %}">Home</a>
          <div class="collapsex navbar-collapsex" id="collapsibleNavId">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
              <li class="nav-item ">
                <a class="nav-link" href="{% url 'app1:broker_profile' %}">Your profile</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'app1:broker_reviews' pk=user.pk %}" >My reviews</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'app1:blog_post_list' %}">Blog</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="{% url 'app1:broker_requests' %}" role="button" aria-haspopup="true" aria-expanded="false"> my requests</a>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="{% url 'app1:broker_pendingrequests' %}">Pending requests</a>
                  <a class="dropdown-item" href="{% url 'app1:broker_acceptedrequests' %}">Accepted requests </a>
                  <a class="dropdown-item" href="{% url 'app1:broker_rejectedrequests' %}">Rejected requests</a>
                  <a class="dropdown-item" href="{% url 'app1:broker_completedrequests' %}">Completed requests</a>
                  <a class="dropdown-item" href="{% url 'app1:broker_requests' %}">All requests</a>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="{% url 'app1:customer_orders' %}" role="button" aria-haspopup="true" aria-expanded="false">Notifications 
                  {% ifequal tl 0  %} 
                  <span id="notification-count-broker" style="color:cyan;"></span>
                  {% else %}
                  <span id="notification-count-broker" style="color:cyan;">{{tl}}</span>
                  {% endifequal %}
                </a>
                <div class="dropdown-menu">
                  {% include "_notification.html" %}
                </div>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="{% url 'app1:broker_logout' %}">logout</a>
              </li>
            </ul>
          </div>
        </nav>
      {% endif %}
    {% else %}
      <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <a class="navbar-brand" href="{% url 'app1:homepage' %}">Workiteasy</a>
        <div class="collapsex navbar-collapsex" id="collapsibleNavId">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item ">
              <a class="nav-link" href="#">About us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" >Contact us </a>
            </li>
            <li class="nav-item"> {# Blog link for non-authenticated users #}
              <a class="nav-link" href="{% url 'app1:blog_post_list' %}">Blog</a>
            </li>
          </ul>
        </div>
    </nav>
    {% endif %}

    {% block content %}
      
    {% endblock content %}
      
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- 35 px for navbar -->

    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

    <style>
      .toast-notification {
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid transparent;
        border-radius: .25rem;
        color: #fff;
        background-color: #007bff; /* Blue default */
        border-color: #007bff;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        min-width: 250px; /* Minimum width for toasts */
      }
      .toast-notification.show {
        opacity: 1;
      }
      .toast-notification.error {
        background-color: #dc3545; /* Red for errors */
        border-color: #dc3545;
      }
      .toast-notification.success {
        background-color: #28a745; /* Green for success */
        border-color: #28a745;
      }
      .toast-notification strong {
        font-weight: bold;
      }
    </style>

    {% if user.is_authenticated %}
    <script>
      function showToastNotification(title, message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast-notification'; // Base class
        
        // Add type class for specific styling (info, success, error)
        if (type === 'success') {
            toast.classList.add('success');
        } else if (type === 'error') {
            toast.classList.add('error');
        } else {
            // Default to info/blue style, no extra class needed if base is blue
        }

        toast.innerHTML = `<strong>${title}</strong><br>${message}`;
        
        container.appendChild(toast);

        // Trigger reflow to enable transition
        toast.offsetHeight; 
        toast.classList.add('show');

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            container.removeChild(toast);
          }, 500); // Allow fade out transition
        }, 5000); // Display toast for 5 seconds
      }

      const notificationSocketProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const notificationSocket = new WebSocket(
        notificationSocketProtocol +
        window.location.host +
        '/ws/notifications/'
      );

      notificationSocket.onopen = function(e) {
        console.log('Notification socket connected successfully.');
      };

      notificationSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Notification received: ", data);

        if (data.message && data.message.event) {
          let toastTitle = "New Notification";
          let toastMessage = "You have a new update.";
          let toastType = "info"; // Default type

          // Customize message based on event
          const eventData = data.message;
          switch(eventData.event) {
            case 'new_connection_request':
              toastTitle = 'New Request!';
              toastMessage = `${eventData.customer_name || 'A customer'} sent you a connection request: ${eventData.description || ''}`;
              break;
            case 'connection_accepted':
            case 'connection_accepted_from_pending':
              toastTitle = 'Request Accepted!';
              toastMessage = `${eventData.broker_name || 'A broker'} accepted your request (ID: ${eventData.connection_id}).`;
              toastType = 'success';
              break;
            case 'connection_rejected':
            case 'connection_rejected_from_pending':
              toastTitle = 'Request Rejected';
              toastMessage = `${eventData.broker_name || 'A broker'} rejected your request (ID: ${eventData.connection_id}).`;
              toastType = 'error';
              break;
            case 'connection_completed':
            case 'connection_completed_from_accepted':
              toastTitle = 'Request Completed!';
              toastMessage = `${eventData.broker_name || 'A broker'} marked your request (ID: ${eventData.connection_id}) as completed.`;
              toastType = 'success';
              break;
            case 'new_chat_message':
              toastTitle = `New Message from ${eventData.sender_name || 'User'}`;
              toastMessage = `"${eventData.message_text || ''}"`;
              // Potentially link to chat: (ID: ${eventData.connection_pk})
              break;
            default:
              toastMessage = `Event: ${eventData.event}`;
          }
          showToastNotification(toastTitle, toastMessage, toastType);

          // Update notification count badge
          let countElement = null;
          if (document.getElementById('notification-count-customer')) {
            countElement = document.getElementById('notification-count-customer');
          } else if (document.getElementById('notification-count-broker')) {
            countElement = document.getElementById('notification-count-broker');
          }

          if (countElement) {
            let currentCount = parseInt(countElement.innerText || "0");
            if (isNaN(currentCount)) currentCount = 0;
            countElement.innerText = currentCount + 1;
            // Ensure the badge is visible if it was hidden (e.g., when count was 0)
            if (currentCount === 0) {
                 // This depends on how visibility is handled; for now, just setting text.
                 // If it's hidden by a class or style, that would need to be adjusted.
            }
          }
        } else {
            showToastNotification("Notification", JSON.stringify(data.message));
        }
      };

      notificationSocket.onclose = function(e) {
        console.error('Notification socket closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
        // Optionally, you could try to reconnect here after a delay
      };

      notificationSocket.onerror = function(err) {
        console.error('Notification socket error:', err.message);
        // Handle errors, maybe show a generic error toast
        // showToastNotification("Error", "Notification service connection failed.", "error");
      };

    </script>
    {% endif %}

  </body>
</html>
