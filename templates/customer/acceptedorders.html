{% extends "base.html" %}

{% block content %}
  <div class="jumbotron">
    <h1>hey customer mr {{ user.username}}</h1>
    <br>
    <br>
    {% if asize %}
    <ul class="list-group">
      <li class="list-group-item"><h3>Accepted Orders:</h3></li>
      {% for item in acceptedorders_with_disputes %}
        <li class="list-group-item">
          <h5>To: {{ item.order.broker.user.username }}</h5>
          <p>Service: {{ item.order.description }}</p>
          <p><small>Requested: {{ item.order.created_time|date:"F d, Y H:i" }} | Accepted: {{ item.order.modified_time|date:"F d, Y H:i" }}</small></p>
          
          {% if item.dispute %}
            <p class="text-danger"><strong>Dispute Status: {{ item.dispute.status }}</strong> (Reported: {{ item.dispute.created_at|date:"F d, Y" }})</p>
            <p><small>Reason: {{ item.dispute.reason|truncatewords:20 }}</small></p>
          {% else %}
            <a href="{% url 'app1:report_dispute' connection_id=item.order.id %}" class="btn btn-warning btn-sm mb-2">Report Issue</a>
          {% endif %}

          <hr>
          <p class="mb-1"><strong>Price:</strong> ${{ item.order.price|default:"Not set" }}</p>
          <p class="mb-1"><strong>Payment Status:</strong> <span class="badge badge-{% if item.order.payment_status == 'Paid' %}success{% elif item.order.payment_status == 'Failed' %}danger{% else %}secondary{% endif %}">{{ item.order.payment_status }}</span></p>
          
          {% if item.order.price and item.order.payment_status == 'Pending' %}
            <a href="{% url 'app1:create_checkout_session' connection_id=item.order.id %}" class="btn btn-success btn-sm my-2">Pay Now (Simulated)</a>
          {% elif item.order.payment_status == 'Paid' %}
            <p class="text-success small">Payment ID: {{ item.order.stripe_payment_intent_id|truncatechars:30 }}</p>
          {% endif %}
          
          <p class="mt-2">You can also chat here with {{ item.order.broker.user.username }}:</p>
          <a href="{% url 'app1:customer_chat' pk=item.order.broker.pk %}" class="btn btn-primary btn-sm" style="float: right;">Chat</a>
        </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
{% endblock content %}
  